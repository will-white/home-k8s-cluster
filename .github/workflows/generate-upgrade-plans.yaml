---
name: Generate Upgrade Plans

on:
  pull_request:
    paths:
      - 'kubernetes/bootstrap/talos/talconfig.yaml'
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to add Plans to'
        required: true
        type: number

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-plans:
    name: Generate System Upgrade Plans
    runs-on: ubuntu-latest
    # The 'paths:' filter above already ensures this only runs when talconfig.yaml changes
    
    steps:
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          token: "${{ github.token }}"
          ref: ${{ github.event_name == 'workflow_dispatch' && format('refs/pull/{0}/head', inputs.pr_number) || github.event.pull_request.head.ref }}
          repository: ${{ github.event_name == 'workflow_dispatch' && github.repository || github.event.pull_request.head.repo.full_name }}

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Detect Version Changes
        id: detect
        run: |
          set -e
          
          # Fetch the base branch to compare
          git fetch origin ${{ github.event_name == 'workflow_dispatch' && github.event.repository.default_branch || github.event.pull_request.base.ref }}
          
          # Get versions from current PR branch
          TALOS_NEW=$(yq '.talosVersion' kubernetes/bootstrap/talos/talconfig.yaml)
          K8S_NEW=$(yq '.kubernetesVersion' kubernetes/bootstrap/talos/talconfig.yaml)
          
          # Get versions from base branch
          BASE_REF=${{ github.event_name == 'workflow_dispatch' && github.event.repository.default_branch || github.event.pull_request.base.ref }}
          git show origin/${BASE_REF}:kubernetes/bootstrap/talos/talconfig.yaml > /tmp/talconfig-base.yaml
          TALOS_OLD=$(yq '.talosVersion' /tmp/talconfig-base.yaml)
          K8S_OLD=$(yq '.kubernetesVersion' /tmp/talconfig-base.yaml)
          
          echo "Talos: $TALOS_OLD â†’ $TALOS_NEW"
          echo "Kubernetes: $K8S_OLD â†’ $K8S_NEW"
          
          # Check if Talos version changed
          if [ "$TALOS_OLD" != "$TALOS_NEW" ]; then
            echo "talos_changed=true" >> $GITHUB_OUTPUT
            echo "talos_version=$TALOS_NEW" >> $GITHUB_OUTPUT
            echo "âœ… Talos version changed"
          else
            echo "talos_changed=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  Talos version unchanged"
          fi
          
          # Check if Kubernetes version changed
          if [ "$K8S_OLD" != "$K8S_NEW" ]; then
            echo "k8s_changed=true" >> $GITHUB_OUTPUT
            echo "k8s_version=$K8S_NEW" >> $GITHUB_OUTPUT
            echo "âœ… Kubernetes version changed"
          else
            echo "k8s_changed=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  Kubernetes version unchanged"
          fi

      - name: Generate Talos Upgrade Plans
        if: steps.detect.outputs.talos_changed == 'true'
        run: |
          VERSION="${{ steps.detect.outputs.talos_version }}"
          
          echo "ðŸ“ Generating Talos upgrade Plans for $VERSION"
          
          # Create plans directory if it doesn't exist
          mkdir -p kubernetes/apps/system-upgrade/plans
          
          # Generate worker upgrade Plan
          cat > kubernetes/apps/system-upgrade/plans/01-talos-workers-upgrade.yaml <<EOF
          ---
          # yaml-language-server: \$schema=https://raw.githubusercontent.com/rancher/system-upgrade-controller/master/pkg/apis/upgrade.cattle.io/v1/plan.json
          apiVersion: upgrade.cattle.io/v1
          kind: Plan
          metadata:
            name: talos-workers
            namespace: system-upgrade
          spec:
            version: ${VERSION}
            serviceAccountName: system-upgrade
            concurrency: 1
            exclusive: true
            nodeSelector:
              matchExpressions:
                - key: node-role.kubernetes.io/control-plane
                  operator: DoesNotExist
            tolerations:
              - key: node-role.kubernetes.io/control-plane
                operator: Exists
            prepare:
              image: ghcr.io/siderolabs/talosctl:${VERSION}
              args:
                - --nodes=\$(NODE_NAME)
                - health
                - --server=false
            upgrade:
              image: ghcr.io/siderolabs/installer:${VERSION}
            drain:
              force: true
              disableEviction: true
              deleteLocalData: true
              ignoreDaemonSets: true
              skipWaitForDeleteTimeout: 60
              timeout: 300
              gracePeriod: 600
          EOF
          
          # Generate control plane upgrade Plan
          cat > kubernetes/apps/system-upgrade/plans/02-talos-controlplane-upgrade.yaml <<EOF
          ---
          # yaml-language-server: \$schema=https://raw.githubusercontent.com/rancher/system-upgrade-controller/master/pkg/apis/upgrade.cattle.io/v1/plan.json
          apiVersion: upgrade.cattle.io/v1
          kind: Plan
          metadata:
            name: talos-controlplane
            namespace: system-upgrade
          spec:
            # Wait for worker Plan to complete before starting
            after:
              - talos-workers
            version: ${VERSION}
            serviceAccountName: system-upgrade
            concurrency: 1
            exclusive: true
            nodeSelector:
              matchLabels:
                node-role.kubernetes.io/control-plane: ""
            tolerations:
              - key: node-role.kubernetes.io/control-plane
                operator: Exists
            prepare:
              image: ghcr.io/siderolabs/talosctl:${VERSION}
              args:
                - --nodes=\$(NODE_NAME)
                - health
                - --server=false
            upgrade:
              image: ghcr.io/siderolabs/installer:${VERSION}
            drain:
              force: false
              disableEviction: false
              deleteLocalData: true
              ignoreDaemonSets: true
              skipWaitForDeleteTimeout: 120
              timeout: 600
              gracePeriod: 900
          EOF
          
          echo "âœ… Generated Talos upgrade Plans"
          
          # Update kustomization.yaml to include the plans
          cat > kubernetes/apps/system-upgrade/plans/kustomization.yaml <<EOF
          ---
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization
          resources:
            - 01-talos-workers-upgrade.yaml
            - 02-talos-controlplane-upgrade.yaml
          EOF
          
          echo "âœ… Updated kustomization.yaml"

      - name: Generate Kubernetes Upgrade Plan
        if: steps.detect.outputs.k8s_changed == 'true'
        run: |
          K8S_VERSION="${{ steps.detect.outputs.k8s_version }}"
          TALOS_VERSION="${{ steps.detect.outputs.talos_version }}"
          
          # If Talos version not changed, get it from current config
          if [ -z "$TALOS_VERSION" ]; then
            TALOS_VERSION=$(yq '.talosVersion' kubernetes/bootstrap/talos/talconfig.yaml)
          fi
          
          echo "ðŸ“ Generating Kubernetes upgrade Plan for $K8S_VERSION"
          
          # Create plans directory if it doesn't exist
          mkdir -p kubernetes/apps/system-upgrade/plans
          
          # Generate Kubernetes upgrade Plan
          # This will run after any Talos upgrades complete
          cat > kubernetes/apps/system-upgrade/plans/03-kubernetes-upgrade.yaml <<EOF
          ---
          # yaml-language-server: \$schema=https://raw.githubusercontent.com/rancher/system-upgrade-controller/master/pkg/apis/upgrade.cattle.io/v1/plan.json
          apiVersion: upgrade.cattle.io/v1
          kind: Plan
          metadata:
            name: kubernetes-upgrade
            namespace: system-upgrade
          spec:
            # Wait for any Talos upgrades to complete first
            after:
              - talos-controlplane
            version: ${K8S_VERSION}
            serviceAccountName: system-upgrade
            concurrency: 1
            exclusive: true
            # Target control plane nodes for K8s upgrade
            nodeSelector:
              matchLabels:
                node-role.kubernetes.io/control-plane: ""
            tolerations:
              - key: node-role.kubernetes.io/control-plane
                operator: Exists
            # Don't drain for K8s upgrades - Talos handles it
            cordon: false
            upgrade:
              image: ghcr.io/siderolabs/talosctl:${TALOS_VERSION}
              command:
                - /bin/sh
              args:
                - -c
                - |
                  set -ex
                  echo "Upgrading Kubernetes to ${K8S_VERSION} on all nodes"
                  # Use talosctl to upgrade Kubernetes across entire cluster
                  talosctl upgrade-k8s --to ${K8S_VERSION}
          EOF
          
          echo "âœ… Generated Kubernetes upgrade Plan"
          
          # Update kustomization.yaml to include K8s plan
          # If Talos plans exist, include those too
          if [ -f kubernetes/apps/system-upgrade/plans/01-talos-workers-upgrade.yaml ]; then
            cat > kubernetes/apps/system-upgrade/plans/kustomization.yaml <<EOF
          ---
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization
          resources:
            - 01-talos-workers-upgrade.yaml
            - 02-talos-controlplane-upgrade.yaml
            - 03-kubernetes-upgrade.yaml
          EOF
          else
            cat > kubernetes/apps/system-upgrade/plans/kustomization.yaml <<EOF
          ---
          apiVersion: kustomize.config.k8s.io/v1beta1
          kind: Kustomization
          resources:
            - 03-kubernetes-upgrade.yaml
          EOF
          fi
          
          echo "âœ… Updated kustomization.yaml"

      - name: Add Upgrade Instructions Comment
        if: steps.detect.outputs.talos_changed == 'true' || steps.detect.outputs.k8s_changed == 'true'
        run: |
          COMMENT="## ðŸ¤– Automated Upgrade Plans Generated

          This PR modifies \`talconfig.yaml\` versions. Upgrade Plans have been automatically generated.

          "
          
          if [ "${{ steps.detect.outputs.talos_changed }}" == "true" ]; then
            COMMENT+="### ðŸ”· Talos Upgrade to ${{ steps.detect.outputs.talos_version }}

          **Upgrade Plans Created:**
          - \`01-talos-workers-upgrade.yaml\` - Worker nodes (applied first)
          - \`02-talos-controlplane-upgrade.yaml\` - Control plane (applied after workers complete)

          **After merging this PR:**

          1. **Flux will automatically apply both Plans**
             - Worker Plan runs first
             - Control plane Plan waits for workers to complete (via \`after:\` dependency)
          
          2. **Monitor the upgrade process:**
             \`\`\`bash
             # Watch Plans and Jobs
             kubectl -n system-upgrade get plans,jobs -w
             
             # Follow logs
             kubectl -n system-upgrade logs -l job-name --follow
             \`\`\`
          
          3. **The upgrade is fully automated!**
             - Workers upgrade one at a time
             - After all workers succeed, control plane upgrades automatically
             - Each control plane node upgrades one at a time

          **Safety Features:**
          - âœ… One node at a time (\`concurrency: 1\`)
          - âœ… Proper drain with CEPH protection
          - âœ… Health checks before upgrade
          - âœ… Manual control plane trigger

          "
          fi
          
          if [ "${{ steps.detect.outputs.k8s_changed }}" == "true" ]; then
            COMMENT+="### â˜¸ï¸ Kubernetes Upgrade to ${{ steps.detect.outputs.k8s_version }}

          **Upgrade Plan Created:**
          - \`03-kubernetes-upgrade.yaml\` - Upgrades Kubernetes across all nodes

          **After merging this PR:**

          1. **If Talos also updated**, Kubernetes upgrade waits for Talos to complete
          2. **Flux automatically applies the Kubernetes upgrade Plan**
          3. **talosctl upgrades Kubernetes** on all control plane and worker nodes
          4. **The upgrade is fully automated!**

          **Monitor the upgrade:**
          \`\`\`bash
          kubectl -n system-upgrade get plans,jobs -w
          kubectl -n system-upgrade logs -l job-name --follow
          \`\`\`

          "
          fi
          
          COMMENT+="---
          
          ðŸ’¡ **Rollback:** If issues occur, delete the Plans:
          \`\`\`bash
          kubectl -n system-upgrade delete plan talos-workers talos-controlplane
          \`\`\`

          ðŸ“š **Documentation:** See \`kubernetes/apps/system-upgrade/README.md\`
          "
          
          echo "$COMMENT" > /tmp/comment.txt
          
          PR_NUMBER=${{ github.event_name == 'workflow_dispatch' && inputs.pr_number || github.event.pull_request.number }}
          gh pr comment $PR_NUMBER --body-file /tmp/comment.txt
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Commit Generated Plans
        if: steps.detect.outputs.talos_changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add kubernetes/apps/system-upgrade/plans/
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "chore(system-upgrade): auto-generate upgrade Plans for ${{ steps.detect.outputs.talos_version }}

          Automatically generated by GitHub Actions when talconfig.yaml was modified.
          
          Plans created:
          - 01-talos-workers-upgrade.yaml (auto-applied by Flux)
          - 02-talos-controlplane-upgrade.yaml (manual application required)"
          
          git push
          
          echo "âœ… Committed and pushed upgrade Plans to PR"
