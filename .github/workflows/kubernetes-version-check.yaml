---
name: Kubernetes Version Check

on:
  schedule:
    # Run every Monday at 10 AM UTC (after Talos check)
    - cron: "0 10 * * 1"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-kubernetes-version:
    name: Check for Kubernetes Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Get Current Kubernetes Version
        id: current
        run: |
          CURRENT_VERSION=$(yq '.kubernetesVersion' kubernetes/bootstrap/talos/talconfig.yaml)
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current Kubernetes version: $CURRENT_VERSION"
          
          # Extract major.minor (e.g., v1.34)
          CURRENT_MAJOR_MINOR=$(echo $CURRENT_VERSION | grep -oP 'v\d+\.\d+')
          echo "major_minor=$CURRENT_MAJOR_MINOR" >> $GITHUB_OUTPUT
          
          # Extract minor version number (e.g., 34 from v1.34.1)
          CURRENT_MINOR=$(echo $CURRENT_VERSION | grep -oP 'v1\.\K\d+')
          echo "minor=$CURRENT_MINOR" >> $GITHUB_OUTPUT

      - name: Get Current Talos Version
        id: talos
        run: |
          TALOS_VERSION=$(yq '.talosVersion' kubernetes/bootstrap/talos/talconfig.yaml)
          echo "version=$TALOS_VERSION" >> $GITHUB_OUTPUT
          echo "Current Talos version: $TALOS_VERSION"

      - name: Determine Upgrade Path
        id: upgrade_path
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          CURRENT_MAJOR_MINOR="${{ steps.current.outputs.major_minor }}"
          CURRENT_MINOR="${{ steps.current.outputs.minor }}"
          TALOS_VERSION="${{ steps.talos.outputs.version }}"
          
          echo "=== Kubernetes Upgrade Path Analysis ==="
          echo "Current Kubernetes version: $CURRENT"
          echo "Current Talos version: $TALOS_VERSION"
          
          # Get all Kubernetes stable releases
          ALL_RELEASES=$(curl -s https://api.github.com/repos/kubernetes/kubernetes/releases | \
            jq -r '[.[] | select(.prerelease == false and (.tag_name | startswith("v1."))) | .tag_name] | .[]')
          
          # Step 1: Find latest patch in current minor version
          LATEST_IN_CURRENT_MINOR=$(echo "$ALL_RELEASES" | \
            grep "^${CURRENT_MAJOR_MINOR}\." | \
            sort -V | tail -1)
          
          echo "Latest in current minor series ($CURRENT_MAJOR_MINOR.x): $LATEST_IN_CURRENT_MINOR"
          
          # Check if we need to update within current minor first
          if [ "$CURRENT" != "$LATEST_IN_CURRENT_MINOR" ]; then
            echo "upgrade_type=patch_update" >> $GITHUB_OUTPUT
            echo "target_version=$LATEST_IN_CURRENT_MINOR" >> $GITHUB_OUTPUT
            echo "upgrade_needed=true" >> $GITHUB_OUTPUT
            echo ""
            echo "ðŸ“‹ Upgrade path: Update to latest patch in current minor series"
            echo "   $CURRENT â†’ $LATEST_IN_CURRENT_MINOR"
            exit 0
          fi
          
          # Step 2: Current minor is up to date, check for next minor version
          # Kubernetes only allows upgrading one minor version at a time
          NEXT_MINOR=$((CURRENT_MINOR + 1))
          NEXT_MINOR_VERSION="v1.${NEXT_MINOR}"
          
          # Find first stable patch release in next minor version
          FIRST_IN_NEXT_MINOR=$(echo "$ALL_RELEASES" | \
            grep "^v1\.${NEXT_MINOR}\." | \
            sort -V | head -1)
          
          if [ -z "$FIRST_IN_NEXT_MINOR" ]; then
            echo "upgrade_needed=false" >> $GITHUB_OUTPUT
            echo "âœ“ Already running latest available version"
            echo "   No v1.${NEXT_MINOR}.x releases found yet"
            exit 0
          fi
          
          echo "First release in next minor (v1.${NEXT_MINOR}.x): $FIRST_IN_NEXT_MINOR"
          
          # Check Talos compatibility
          # Generally: Talos N supports Kubernetes N-2, N-1, N, N+1
          # For safety, recommend upgrading to initial stable release (.0) first
          echo "upgrade_type=minor_upgrade" >> $GITHUB_OUTPUT
          echo "target_version=$FIRST_IN_NEXT_MINOR" >> $GITHUB_OUTPUT
          echo "upgrade_needed=true" >> $GITHUB_OUTPUT
          echo ""
          echo "ðŸ“‹ Upgrade path: Minor version upgrade"
          echo "   $CURRENT â†’ $FIRST_IN_NEXT_MINOR"
          echo "   (After this, will upgrade to latest patch in v1.${NEXT_MINOR}.x series)"
          echo ""
          echo "âš ï¸  NOTE: Verify Talos $TALOS_VERSION supports Kubernetes $FIRST_IN_NEXT_MINOR"
          echo "   See: https://www.talos.dev/latest/introduction/support-matrix/"

      - name: Create Upgrade Branch
        if: steps.upgrade_path.outputs.upgrade_needed == 'true'
        run: |
          TARGET="${{ steps.upgrade_path.outputs.target_version }}"
          BRANCH_NAME="kubernetes-upgrade-${TARGET}"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout -b "$BRANCH_NAME"
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
        id: branch

      - name: Update talconfig.yaml
        if: steps.upgrade_path.outputs.upgrade_needed == 'true'
        run: |
          TARGET="${{ steps.upgrade_path.outputs.target_version }}"
          
          # Update kubernetesVersion in talconfig.yaml
          yq -i '.kubernetesVersion = "'"$TARGET"'"' kubernetes/bootstrap/talos/talconfig.yaml
          
          echo "âœ“ Updated talconfig.yaml to Kubernetes $TARGET"

      - name: Create Upgrade Instructions
        if: steps.upgrade_path.outputs.upgrade_needed == 'true'
        run: |
          TARGET="${{ steps.upgrade_path.outputs.target_version }}"
          CURRENT="${{ steps.current.outputs.version }}"
          UPGRADE_TYPE="${{ steps.upgrade_path.outputs.upgrade_type }}"
          TALOS_VERSION="${{ steps.talos.outputs.version }}"
          
          if [ "$UPGRADE_TYPE" = "patch_update" ]; then
            UPGRADE_DESC="Patch update within current minor series"
            NEXT_STEPS="After this upgrade completes, the workflow will check for the next minor version."
          else
            UPGRADE_DESC="Minor version upgrade"
            NEXT_STEPS="After this upgrade completes, the workflow will check for the latest patch in the new minor series."
          fi
          
          cat > UPGRADE_INSTRUCTIONS.md << 'EOF'
          # Kubernetes Upgrade: $CURRENT â†’ $TARGET
          
          ## Upgrade Type: $UPGRADE_DESC
          
          This PR automates the upgrade of Kubernetes from **$CURRENT** to **$TARGET**.
          
          ### Kubernetes Upgrade Path
          
          Kubernetes requires a specific upgrade sequence:
          1. **Update to latest patch in current minor version** (e.g., v1.34.0 â†’ v1.34.5)
          2. **Then upgrade to next minor** (e.g., v1.34.5 â†’ v1.35.0)
          3. **Repeat**: One minor version at a time (cannot skip)
          
          This PR represents one step in that path. $NEXT_STEPS
          
          ### Talos Compatibility
          
          **Current Talos Version**: $TALOS_VERSION
          
          Verify compatibility: https://www.talos.dev/$TALOS_VERSION/introduction/support-matrix/
          
          Talos typically supports Kubernetes versions N-2 through N+1.
          
          ## Upgrade Process
          
          **IMPORTANT**: Kubernetes upgrades in Talos are performed using `talosctl upgrade-k8s`.
          
          ### Recommended Approach: Manual Upgrade via Task
          
          The safest and most reliable method is to use the existing Task command:
          
          ```bash
          # This upgrades the entire cluster in the correct sequence
          task talos:upgrade-k8s
          ```
          
          This command:
          - âœ“ Upgrades all control plane nodes first (in sequence)
          - âœ“ Upgrades worker nodes automatically
          - âœ“ Maintains etcd quorum throughout the process
          - âœ“ Ensures API server availability
          - âœ“ Provides real-time feedback and error handling
          - âœ“ Uses the version specified in talconfig.yaml
          
          Monitor progress:
          ```bash
          # Watch nodes upgrade
          kubectl get nodes -w
          
          # Check Kubernetes version on nodes
          kubectl get nodes -o wide
          
          # Verify control plane components
          kubectl get pods -n kube-system
          ```
          
          ### Alternative: System Upgrade Controller (Not Recommended for K8s)
          
          While the System Upgrade Controller works well for Talos OS upgrades, 
          Kubernetes version upgrades are better handled by Talos's native 
          `upgrade-k8s` command because:
          
          - Control plane must upgrade in specific sequence (etcd, API server, etc.)
          - Requires coordination across all control plane nodes
          - Talos handles complex orchestration internally
          - Better error handling and rollback capabilities
          
          ## Safety Considerations
          
          - âœ“ **Backup etcd** before upgrading (optional but recommended)
          - âœ“ **Test in non-production** first if possible
          - âœ“ **Verify addon compatibility** with new Kubernetes version
          - âœ“ **Check Cilium/CNI compatibility**
          - âœ“ **Review breaking changes** in release notes
          
          ## Pre-Upgrade Checklist
          
          Before running the upgrade:
          
          - [ ] Verify Talos compatibility matrix
          - [ ] Review Kubernetes $TARGET release notes
          - [ ] Check that all nodes are healthy: `kubectl get nodes`
          - [ ] Verify cluster resources are stable: `kubectl get pods -A`
          - [ ] Ensure sufficient time for upgrade (15-30 minutes)
          - [ ] Backup important data if needed
          
          ## Upgrade Steps
          
          1. **Merge this PR** to update talconfig.yaml
          
          2. **Run the Task command**:
             ```bash
             task talos:upgrade-k8s
             ```
          
          3. **Monitor the upgrade**:
             ```bash
             watch kubectl get nodes -o wide
             ```
          
          4. **Verify completion**:
             ```bash
             kubectl version
             kubectl get nodes
             kubectl get pods -A
             ```
          
          ## Rollback
          
          Kubernetes does not support downgrade. If issues occur:
          
          1. **Do not proceed** with additional nodes if any fail
          2. **Check logs**: `kubectl logs -n kube-system <pod>`
          3. **Consult Talos documentation** for recovery procedures
          4. **Restore from etcd backup** if critical failure
          
          ## Release Notes
          
          View Kubernetes $TARGET release notes: https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-${CURRENT_MAJOR_MINOR#v}.md
          
          ## Next Steps After This Upgrade
          
          $NEXT_STEPS
          
          The automated workflow will continue monitoring and create PRs for subsequent upgrades automatically.
          
          ---
          
          **Note**: This PR only updates talconfig.yaml. The actual upgrade must be performed manually using `task talos:upgrade-k8s`.
          EOF
          
          # Replace variables
          sed -i "s/\$CURRENT/$CURRENT/g" UPGRADE_INSTRUCTIONS.md
          sed -i "s/\$TARGET/$TARGET/g" UPGRADE_INSTRUCTIONS.md
          sed -i "s/\$UPGRADE_DESC/$UPGRADE_DESC/g" UPGRADE_INSTRUCTIONS.md
          sed -i "s/\$NEXT_STEPS/$NEXT_STEPS/g" UPGRADE_INSTRUCTIONS.md
          sed -i "s/\$TALOS_VERSION/$TALOS_VERSION/g" UPGRADE_INSTRUCTIONS.md
          sed -i "s/\${CURRENT_MAJOR_MINOR#v}/${CURRENT_MAJOR_MINOR#v}/g" UPGRADE_INSTRUCTIONS.md

      - name: Commit Changes
        if: steps.upgrade_path.outputs.upgrade_needed == 'true'
        run: |
          TARGET="${{ steps.upgrade_path.outputs.target_version }}"
          UPGRADE_TYPE="${{ steps.upgrade_path.outputs.upgrade_type }}"
          
          if [ "$UPGRADE_TYPE" = "patch_update" ]; then
            COMMIT_TYPE="patch update"
          else
            COMMIT_TYPE="minor upgrade"
          fi
          
          git add kubernetes/bootstrap/talos/talconfig.yaml
          git add UPGRADE_INSTRUCTIONS.md
          
          git commit -m "chore(kubernetes): $COMMIT_TYPE to $TARGET

          - Update talconfig.yaml to Kubernetes $TARGET
          - Manual upgrade required: task talos:upgrade-k8s
          - See UPGRADE_INSTRUCTIONS.md for detailed process
          
          This is a configuration update only. The actual cluster upgrade
          must be performed manually using the Task command."

      - name: Push Branch
        if: steps.upgrade_path.outputs.upgrade_needed == 'true'
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.branch }}"
          git push origin "$BRANCH_NAME"

      - name: Create Pull Request
        if: steps.upgrade_path.outputs.upgrade_needed == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TARGET="${{ steps.upgrade_path.outputs.target_version }}"
          CURRENT="${{ steps.current.outputs.version }}"
          BRANCH_NAME="${{ steps.branch.outputs.branch }}"
          UPGRADE_TYPE="${{ steps.upgrade_path.outputs.upgrade_type }}"
          
          if [ "$UPGRADE_TYPE" = "patch_update" ]; then
            PR_TITLE="chore(kubernetes): patch update to $TARGET"
          else
            PR_TITLE="chore(kubernetes): minor upgrade to $TARGET"
          fi
          
          gh pr create \
            --base main \
            --head "$BRANCH_NAME" \
            --title "$PR_TITLE" \
            --body-file UPGRADE_INSTRUCTIONS.md \
            --label "kubernetes" \
            --label "upgrade" \
            --label "automation" \
            --label "manual-action-required"
          
          echo "âœ“ Pull request created successfully"

      - name: Summary
        if: steps.upgrade_path.outputs.upgrade_needed == 'true'
        run: |
          TARGET="${{ steps.upgrade_path.outputs.target_version }}"
          CURRENT="${{ steps.current.outputs.version }}"
          UPGRADE_TYPE="${{ steps.upgrade_path.outputs.upgrade_type }}"
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸš€ Kubernetes Upgrade Available
          
          **Current Version**: $CURRENT  
          **Target Version**: $TARGET  
          **Upgrade Type**: $UPGRADE_TYPE
          
          A pull request has been created with:
          - âœ“ Updated talconfig.yaml
          - âœ“ Detailed upgrade instructions
          - âœ“ Compatibility verification steps
          - âš ï¸  **Manual upgrade required**
          
          ## Upgrade Path
          
          Kubernetes follows a strict upgrade sequence:
          1. Latest patch in current minor series
          2. Then next minor version
          3. One minor version at a time (cannot skip)
          
          This PR: **$CURRENT â†’ $TARGET**
          
          ## Next Steps
          
          1. Review the pull request
          2. Verify Talos compatibility
          3. Merge when ready (updates configuration only)
          4. **Manually run**: \`task talos:upgrade-k8s\`
          5. Monitor cluster during upgrade
          6. Wait for next automated PR if more upgrades are needed
          
          ## Important
          
          Unlike Talos OS upgrades, Kubernetes upgrades are NOT automated via System Upgrade Controller.
          You must manually execute \`task talos:upgrade-k8s\` after merging the PR.
          
          EOF

      - name: No Upgrade Needed
        if: steps.upgrade_path.outputs.upgrade_needed != 'true'
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # âœ“ Kubernetes Up to Date
          
          Current version **$CURRENT** is the latest available.
          
          No action needed.
          EOF
