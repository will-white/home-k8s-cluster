---
# Example Plan for Talos OS upgrades
# This plan is DISABLED by default (no nodeSelector matches all nodes)
# To enable: Add appropriate nodeSelector labels
apiVersion: upgrade.cattle.io/v1
kind: Plan
metadata:
  name: talos-upgrade
  namespace: system-upgrade
spec:
  # Maximum number of nodes to upgrade concurrently
  concurrency: 1
  
  # Prevent other Plans from running simultaneously
  exclusive: true
  
  # Target Talos version (update this when upgrading)
  # Find versions at: https://github.com/siderolabs/talos/releases
  version: v1.11.5
  
  # Alternatively, use a channel for automatic version discovery
  # channel: https://factory.talos.dev/installer/376567988ad370138ad8b2698212367b8edcb69b5fd68c80be1f2ec7d603b4ba/latest.txt
  
  # Node selector - MUST be configured to enable upgrades
  # Example: Upgrade worker nodes first
  # nodeSelector:
  #   matchLabels:
  #     node-role.kubernetes.io/worker: ""
  
  # Service account with necessary permissions
  serviceAccountName: system-upgrade
  
  # Cordon node before upgrade
  cordon: true
  
  # Drain configuration
  drain:
    # Force drain (removes pods even if PDBs would be violated)
    force: true
    # Ignore DaemonSets during drain
    ignoreDaemonSets: true
    # Delete pods with emptyDir volumes
    deleteEmptyDirData: true
    # Disable eviction API (use deletion instead)
    disableEviction: true
    # Timeout for drain operation (seconds)
    timeout: 900
    # Grace period for pod termination (seconds)
    gracePeriod: 600
    # Skip waiting for pod deletion timeout
    skipWaitForDeleteTimeout: 60
  
  # Tolerations to allow Job pods to run on all nodes
  tolerations:
    - key: CriticalAddonsOnly
      operator: Exists
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule
    - key: node-role.kubernetes.io/master
      operator: Exists
      effect: NoSchedule
  
  # Upgrade container - runs the actual Talos upgrade
  upgrade:
    # Talos upgrade image with schematic ID from your talconfig.yaml
    # Factory URL format: factory.talos.dev/installer/<schematic-id>:<version>
    image: factory.talos.dev/installer/376567988ad370138ad8b2698212367b8edcb69b5fd68c80be1f2ec7d603b4ba:v1.11.5
    command:
      - /bin/sh
    args:
      - -c
      - |
        set -ex
        # Talos installer is already at /usr/install in the image
        talosctl upgrade \
          --insecure \
          --nodes $SYSTEM_UPGRADE_NODE_NAME \
          --image factory.talos.dev/installer/376567988ad370138ad8b2698212367b8edcb69b5fd68c80be1f2ec7d603b4ba:v1.11.5 \
          --preserve
    env:
      - name: SYSTEM_UPGRADE_NODE_NAME
        valueFrom:
          fieldRef:
            fieldPath: spec.nodeName
    # Mount host root filesystem (required for some upgrade operations)
    volumeMounts:
      - name: host-root
        mountPath: /host
        readOnly: false

---
# Note: To use this Plan, you need to:
# 1. Update the version and image to match your target Talos version
# 2. Configure appropriate nodeSelector (start with workers, then control plane)
# 3. Apply the Plan: kubectl apply -f talos-upgrade.yaml
# 4. Monitor progress: kubectl -n system-upgrade get plans
# 5. Check Jobs: kubectl -n system-upgrade get jobs
#
# For safer manual upgrades, use the existing Task commands:
#   task talos:upgrade-node HOSTNAME=<node-name>
