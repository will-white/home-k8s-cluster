---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: version-checker
  namespace: system-upgrade
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: version-checker
rules:
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: version-checker
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: version-checker
subjects:
  - kind: ServiceAccount
    name: version-checker
    namespace: system-upgrade
---
apiVersion: v1
kind: Secret
metadata:
  name: github-token
  namespace: system-upgrade
type: Opaque
stringData:
  token: "" # Add your GitHub PAT here or use ExternalSecret
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: talos-version-checker
  namespace: system-upgrade
spec:
  # Check for new versions weekly on Monday at 9 AM
  schedule: "0 9 * * 1"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      ttlSecondsAfterFinished: 86400
      template:
        spec:
          serviceAccountName: version-checker
          restartPolicy: OnFailure
          containers:
            - name: version-checker
              image: ghcr.io/siderolabs/talosctl:v1.11.5
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  
                  echo "=== Talos Version Checker (In-Cluster) ==="
                  
                  # Get current Talos version from actual running nodes
                  CURRENT_VERSION=$(kubectl get nodes -o jsonpath='{.items[0].status.nodeInfo.osImage}' | grep -oP 'v\d+\.\d+\.\d+')
                  echo "Current Talos version (from cluster): $CURRENT_VERSION"
                  
                  # Extract major.minor
                  CURRENT_MAJOR_MINOR=$(echo $CURRENT_VERSION | grep -oP 'v\d+\.\d+')
                  CURRENT_MAJOR=$(echo $CURRENT_VERSION | grep -oP 'v\d+' | grep -oP '\d+')
                  
                  echo "Current major.minor: $CURRENT_MAJOR_MINOR"
                  
                  # Check for latest version
                  ALL_RELEASES=$(wget -qO- https://api.github.com/repos/siderolabs/talos/releases | \
                    grep -oP '"tag_name": "\Kv[0-9]+\.[0-9]+\.[0-9]+' | grep -v '-' | sort -V)
                  
                  # Find latest patch in current minor version
                  LATEST_IN_CURRENT_MINOR=$(echo "$ALL_RELEASES" | grep "^${CURRENT_MAJOR_MINOR}\." | tail -1)
                  echo "Latest in current minor series: $LATEST_IN_CURRENT_MINOR"
                  
                  if [ "$CURRENT_VERSION" != "$LATEST_IN_CURRENT_MINOR" ]; then
                    echo "⚠ Upgrade available: $CURRENT_VERSION → $LATEST_IN_CURRENT_MINOR"
                    echo "UPGRADE_TYPE=patch_update"
                    echo "TARGET_VERSION=$LATEST_IN_CURRENT_MINOR"
                    # Future: Create GitHub issue or send notification
                    # For now, just log it - maintainer will see in CronJob logs
                    exit 0
                  fi
                  
                  # Check for next major version
                  NEXT_MAJOR=$((CURRENT_MAJOR + 1))
                  FIRST_IN_NEXT_MAJOR=$(echo "$ALL_RELEASES" | grep "^v${NEXT_MAJOR}\.0\." | head -1)
                  
                  if [ -n "$FIRST_IN_NEXT_MAJOR" ]; then
                    echo "⚠ Major upgrade available: $CURRENT_VERSION → $FIRST_IN_NEXT_MAJOR"
                    echo "UPGRADE_TYPE=major_upgrade"
                    echo "TARGET_VERSION=$FIRST_IN_NEXT_MAJOR"
                    exit 0
                  fi
                  
                  echo "✓ Already running latest available version"
              env:
                - name: KUBERNETES_SERVICE_HOST
                  value: kubernetes.default.svc
                - name: KUBERNETES_SERVICE_PORT
                  value: "443"
              resources:
                requests:
                  cpu: 10m
                  memory: 32Mi
                limits:
                  memory: 128Mi
              securityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  drop:
                    - ALL
                readOnlyRootFilesystem: true
                runAsNonRoot: true
                runAsUser: 65534
                seccompProfile:
                  type: RuntimeDefault
